"""Unit test for rpnstd.py and Fstd.py"""

import rpnstd
from jimc import *
import numpy
import unittest

class jimcXchHaloTest(unittest.TestCase):

    def testjimc_new_array(self):
        """jimc_new_array should give known result with known input"""
        ndiv = 2
        nk   = 1
        f    = jimc_new_array(ndiv,nk)
        halo = 2
        nij  = 4
        nijh = nij+2*halo
        ngrids = 10
        flags = {
            'C_CONTIGUOUS' : False,
            'F_CONTIGUOUS' : True,
            'OWNDATA' : True,
            'WRITEABLE' : True,
            'ALIGNED' : True,
            'UPDATEIFCOPY' : False
        }
        stride0=4
        self.assertEqual(f.flags['F_CONTIGUOUS'],flags['F_CONTIGUOUS'])
        self.assertEqual(f.strides[0],stride0)
        self.assertEqual(f.dtype,numpy.dtype('float32'))
        self.assertEqual(f.shape,(nijh,nijh,ngrids))
        nk   = 5
        f    = jimc_new_array(ndiv,nk)
        self.assertEqual(f.shape,(nijh,nijh,nk,ngrids))


    def testjimc_grid(self):
        """jimc_grid should give known result with known input"""
        la0 = numpy.array(
            [[[ 26.56505203, -26.56505203,  26.56505203, -26.56505203,
            26.56505203, -26.56505203,  26.56505203, -26.56505203,
            26.56505203, -26.56505203],
            [ 42.42378998, -13.4416151 ,  42.42378998, -13.4416151 ,
            42.42378998, -13.4416151 ,  42.42378998, -13.4416151 ,
            42.42378998, -13.4416151 ],
            [ 58.28252411,   0.        ,  58.28252411,   0.        ,
            58.28252411,   0.        ,  58.28252411,   0.        ,
            58.28252411,   0.        ],
            [ 74.14126587,  13.4416151 ,  74.14126587,  13.4416151 ,
            74.14126587,  13.4416151 ,  74.14126587,  13.4416151 ,
            74.14126587,  13.4416151 ]],
        [[ 13.4416151 , -42.42378998,  13.4416151 , -42.42378998,
            13.4416151 , -42.42378998,  13.4416151 , -42.42378998,
            13.4416151 , -42.42378998],
            [ 30.37922096, -30.37922096,  30.37922096, -30.37922096,
            30.37922096, -30.37922096,  30.37922096, -30.37922096,
            30.37922096, -30.37922096],
            [ 46.35307312, -16.0450573 ,  46.35307312, -16.0450573 ,
            46.35307312, -16.0450573 ,  46.35307312, -16.0450573 ,
            46.35307312, -16.0450573 ],
            [ 63.43494797,   0.        ,  63.43494797,   0.        ,
            63.43494797,   0.        ,  63.43494797,   0.        ,
            63.43494797,   0.        ]],
        [[  0.        , -58.28252411,   0.        , -58.28252411,
            0.        , -58.28252411,   0.        , -58.28252411,
            0.        , -58.28252411],
            [ 16.0450573 , -46.35307312,  16.0450573 , -46.35307312,
            16.0450573 , -46.35307312,  16.0450573 , -46.35307312,
            16.0450573 , -46.35307312],
            [ 31.71747398, -31.71747398,  31.71747398, -31.71747398,
            31.71747398, -31.71747398,  31.71747398, -31.71747398,
            31.71747398, -31.71747398],
            [ 46.35307312, -16.0450573 ,  46.35307312, -16.0450573 ,
            46.35307312, -16.0450573 ,  46.35307312, -16.0450573 ,
            46.35307312, -16.0450573 ]],
        [[-13.4416151 , -74.14126587, -13.4416151 , -74.14126587,
            -13.4416151 , -74.14126587, -13.4416151 , -74.14126587,
            -13.4416151 , -74.14126587],
            [  0.        , -63.43494797,   0.        , -63.43494797,
            0.        , -63.43494797,   0.        , -63.43494797,
            0.        , -63.43494797],
            [ 16.0450573 , -46.35307312,  16.0450573 , -46.35307312,
            16.0450573 , -46.35307312,  16.0450573 , -46.35307312,
            16.0450573 , -46.35307312],
            [ 30.37922096, -30.37922096,  30.37922096, -30.37922096,
            30.37922096, -30.37922096,  30.37922096, -30.37922096,
            30.37922096, -30.37922096]]]
            ,dtype=numpy.dtype('float32'),order='FORTRAN')
        lo0 = numpy.array(
            [[[ -36.        ,    0.        ,   36.        ,   72.        ,
            108.        ,  144.        ,  180.        , -144.        ,
            -108.        ,  -72.        ],
            [ -36.        ,    9.50570583,   36.        ,   81.50570679,
            108.        ,  153.50570679,  180.        , -134.49429321,
            -108.        ,  -62.49429321],
            [ -36.        ,   18.        ,   36.        ,   90.        ,
            108.        ,  162.        ,  180.        , -126.        ,
            -108.        ,  -54.        ],
            [ -36.        ,   26.49429321,   36.        ,   98.49429321,
            108.        ,  170.49429321,  180.        , -117.50570679,
            -108.        ,  -45.50570679]],
        [[ -26.49429321,    0.        ,   45.50570679,   72.        ,
            117.50570679,  144.        , -170.49429321, -144.        ,
            -98.49429321,  -72.        ],
            [ -18.46699715,   17.53300285,   53.53300476,   89.53300476,
            125.53300476,  161.53300476, -162.46699524, -126.46699524,
            -90.46699524,  -54.46699524],
            [ -13.61382198,   26.26769829,   58.38617706,   98.2677002 ,
            130.38618469,  170.2677002 , -157.61381531, -117.7322998 ,
            -85.61382294,  -45.7322998 ],
            [   0.        ,   36.        ,   72.        ,  108.        ,
            144.        ,  180.        , -144.        , -108.        ,
            -72.        ,  -36.        ]],
        [[ -18.        ,    0.        ,   54.        ,   72.        ,
            126.        ,  144.        , -162.        , -144.        ,
            -90.        ,  -72.        ],
            [  -9.73230171,   22.38617706,   62.2677002 ,   94.38617706,
            134.2677002 ,  166.38618469, -153.7322998 , -121.61382294,
            -81.7322998 ,  -49.61382294],
            [   0.        ,   36.        ,   72.        ,  108.        ,
            144.        ,  180.        , -144.        , -108.        ,
            -72.        ,  -36.        ],
            [  13.61382198,   45.7322998 ,   85.61382294,  117.7322998 ,
            157.61381531, -170.2677002 , -130.38618469,  -98.2677002 ,
            -58.38617706,  -26.26769829]],
        [[  -9.50570583,    0.        ,   62.49429321,   72.        ,
            134.49429321,  144.        , -153.50570679, -144.        ,
            -81.50570679,  -72.        ],
            [   0.        ,   36.        ,   72.        ,  108.        ,
            144.        ,  180.        , -144.        , -108.        ,
            -72.        ,  -36.        ],
            [   9.73230171,   49.61382294,   81.7322998 ,  121.61382294,
            153.7322998 , -166.38618469, -134.2677002 ,  -94.38617706,
            -62.2677002 ,  -22.38617706],
            [  18.46699715,   54.46699524,   90.46699524,  126.46699524,
            162.46699524, -161.53300476, -125.53300476,  -89.53300476,
            -53.53300476,  -17.53300285]]]
            ,dtype=numpy.dtype('float32'),order='FORTRAN')
        ndiv    = 2
        (la,lo) = jimc_grid_la_lo(ndiv)
        istat = jimc_xch_halo(la)
        istat = jimc_xch_halo(lo)
        self.assertEqual(la[2,6,0], 90.)
        self.assertEqual(la[6,2,1],-90.)
        for igrid in range(0,10):
            #print igrid,numpy.any(la[2:6,2:6,igrid]!=la0[...,igrid]),numpy.any(lo[2:6,2:6,igrid]!=lo0[...,igrid])
            if numpy.any(la[2:6,2:6,igrid]!=la0[...,igrid]):
                print 'la',la[2:6,2:6,igrid]!=la0[...,igrid]
                print numpy.array_repr(la[2:6,2:6,igrid],precision=1)
                print numpy.array_repr(la0[...,igrid],precision=1)
            if numpy.any(lo[2:6,2:6,igrid]!=lo0[...,igrid]):
                print 'lo',lo[2:6,2:6,igrid]!=lo0[...,igrid]
                print numpy.array_repr(lo[2:6,2:6,igrid],precision=1)
                print numpy.array_repr(lo0[...,igrid],precision=1)
            self.assertFalse(numpy.any(la[2:6,2:6,igrid]!=la0[...,igrid]))
            self.assertFalse(numpy.any(lo[2:6,2:6,igrid]!=lo0[...,igrid]))


    def testjimc_xch_halo(self):
        """jimc_xch_halo should give known result with known input"""
        a = numpy.array(
            [[[   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.]],
        [[   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [ 841.,   14.,   41.,  214.,  241.,  414.,  441.,  614.,  641.,
            814.],
            [ 842.,   24.,   42.,  224.,  242.,  424.,  442.,  624.,  642.,
            824.],
            [ 843.,   34.,   43.,  234.,  243.,  434.,  443.,  634.,  643.,
            834.],
            [ 844.,   44.,   44.,  244.,  244.,  444.,  444.,  644.,  644.,
            844.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.]],
        [[   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [ 941.,  914.,  141.,  114.,  341.,  314.,  541.,  514.,  741.,
            714.],
            [  11.,  111.,  211.,  311.,  411.,  511.,  611.,  711.,  811.,
            911.],
            [  21.,  121.,  221.,  321.,  421.,  521.,  621.,  721.,  821.,
            921.],
            [  31.,  131.,  231.,  331.,  431.,  531.,  631.,  731.,  831.,
            931.],
            [  41.,  141.,  241.,  341.,  441.,  541.,  641.,  741.,  841.,
            941.],
            [ 999.,  211.,  999.,  411.,  999.,  611.,  999.,  811.,  999.,
            11.],
            [ 641.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.]],
        [[   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [ 942.,  924.,  142.,  124.,  342.,  324.,  542.,  524.,  742.,
            724.],
            [  12.,  112.,  212.,  312.,  412.,  512.,  612.,  712.,  812.,
            912.],
            [  22.,  122.,  222.,  322.,  422.,  522.,  622.,  722.,  822.,
            922.],
            [  32.,  132.,  232.,  332.,  432.,  532.,  632.,  732.,  832.,
            932.],
            [  42.,  142.,  242.,  342.,  442.,  542.,  642.,  742.,  842.,
            942.],
            [ 211.,  212.,  411.,  412.,  611.,  612.,  811.,  812.,   11.,
            12.],
            [ 441.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.]],
        [[   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [ 943.,  934.,  143.,  134.,  343.,  334.,  543.,  534.,  743.,
            734.],
            [  13.,  113.,  213.,  313.,  413.,  513.,  613.,  713.,  813.,
            913.],
            [  23.,  123.,  223.,  323.,  423.,  523.,  623.,  723.,  823.,
            923.],
            [  33.,  133.,  233.,  333.,  433.,  533.,  633.,  733.,  833.,
            933.],
            [  43.,  143.,  243.,  343.,  443.,  543.,  643.,  743.,  843.,
            943.],
            [ 221.,  213.,  421.,  413.,  621.,  613.,  821.,  813.,   21.,
            13.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.]],
        [[   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [ 944.,  944.,  144.,  144.,  344.,  344.,  544.,  544.,  744.,
            744.],
            [  14.,  114.,  214.,  314.,  414.,  514.,  614.,  714.,  814.,
            914.],
            [  24.,  124.,  224.,  324.,  424.,  524.,  624.,  724.,  824.,
            924.],
            [  34.,  134.,  234.,  334.,  434.,  534.,  634.,  734.,  834.,
            934.],
            [  44.,  144.,  244.,  344.,  444.,  544.,  644.,  744.,  844.,
            944.],
            [ 231.,  214.,  431.,  414.,  631.,  614.,  831.,  814.,   31.,
            14.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.]],
        [[   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [ 111., -999.,  311., -999.,  511., -999.,  711., -999.,  911.,
            -999.],
            [ 121.,  311.,  321.,  511.,  521.,  711.,  721.,  911.,  921.,
            111.],
            [ 131.,  312.,  331.,  512.,  531.,  712.,  731.,  912.,  931.,
            112.],
            [ 141.,  313.,  341.,  513.,  541.,  713.,  741.,  913.,  941.,
            113.],
            [ 241.,  314.,  441.,  514.,  641.,  714.,  841.,  914.,   41.,
            114.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.]],
        [[   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,  741.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,  541.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.],
            [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
                0.]]]
            ,dtype=numpy.dtype('float32'),order='FORTRAN')
        ndiv = 2
        nk   = 1
        f    = jimc_new_array(ndiv,nk)
        halo = 2
        nij    = f.shape[0] - 2*halo
        ngrids = f.shape[2]
        ijlist = range(halo,halo+nij)
        f[...] = 0.
        for g in range(ngrids):
            for j in ijlist:
                for i in ijlist:
                    f[i,j,g] = g*100.+(j-1)*10.+i-1
        f[halo,nij+halo,0] =  999.
        f[nij+halo,halo,1] = -999.
        #print numpy.array_repr(f[1:7,1:7,0],precision=1)
        f0 = f.copy()
        istat = jimc_xch_halo(f)
        #print numpy.array_repr(f[1:7,1:7,0],precision=1)
        #print numpy.array_repr(f)
        for igrid in range(0,10):
            #print g,numpy.any(f[2:6,2:6,g]!=f0[2:6,2:6,g])
            #print f[1:7,1:7,g]==f0[1:7,1:7,g]
            #print f[...,g]==f0[...,g]
            self.assertFalse(numpy.any(f[...,igrid]!=a[...,igrid]))

if __name__ == "__main__":
    unittest.main()
